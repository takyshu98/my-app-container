AWSTemplateFormatVersion: "2010-09-09"
Description: The template used to create an ECS Cluster from the ECS Console.
Parameters:
  Env:
    Description: Environment
    Type: String
  System:
    Description: System Name
    Type: String
  Image:
    Description: Image
    Type: String
    Default: "032465545722.dkr.ecr.ap-northeast-1.amazonaws.com/poc/my-app-container:latest"
Resources:
  EcsLogGroup:
    UpdateReplacePolicy: Retain
    Type: AWS::Logs::LogGroup
    DeletionPolicy: Delete
    Properties:
      FieldIndexPolicies: []
      LogGroupClass: STANDARD
      LogGroupName: !Sub /ecs/${Env}--${System}--etd
      DataProtectionPolicy: {}
  EcsCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub ${Env}--${System}--ecs--cluster
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      ClusterSettings:
        - Name: containerInsights
          Value: disabled
      ServiceConnectDefaults:
        Namespace: !Sub ${Env}--${System}
      Tags:
        - Key: Name
          Value: !Sub ${Env}--${System}--ecs--cluster
  EcsTaskDefinition:
    UpdateReplacePolicy: "Retain"
    Type: "AWS::ECS::TaskDefinition"
    DeletionPolicy: "Delete"
    Properties:
      ExecutionRoleArn:
        Fn::GetAtt:
          - "EcsTaskExecutionRole"
          - "Arn"
      RuntimePlatform:
        OperatingSystemFamily: "LINUX"
        CpuArchitecture: "X86_64"
      Volumes: []
      InferenceAccelerators: []
      Memory: "1024"
      PlacementConstraints: []
      ContainerDefinitions:
        - ExtraHosts: []
          Secrets: []
          VolumesFrom: []
          Cpu: 0
          EntryPoint: []
          DnsServers: []
          Image: !Ref Image
          Essential: true
          LogConfiguration:
            SecretOptions: []
            Options:
              awslogs-group: !Ref EcsLogGroup
              mode: "non-blocking"
              max-buffer-size: "25m"
              awslogs-create-group: "true"
              awslogs-region: "ap-northeast-1"
              awslogs-stream-prefix: "ecs"
            LogDriver: "awslogs"
          ResourceRequirements: []
          EnvironmentFiles: []
          Name: !Sub ${Env}--${System}--container
          MountPoints: []
          DependsOn: []
          DockerLabels: {}
          PortMappings:
            - ContainerPort: 3000
              AppProtocol: "http"
              Protocol: "tcp"
              HostPort: 3000
              Name: !Sub ${Env}--${System}--container--3000--tcp
          DockerSecurityOptions: []
          SystemControls: []
          Command: []
          DnsSearchDomains: []
          Environment: []
          Links: []
          CredentialSpecs: []
          Ulimits: []
      Cpu: "512"
      RequiresCompatibilities:
        - "FARGATE"
      Family: !Sub ${Env}--${System}--etd
      NetworkMode: "awsvpc"
      Tags:
        - Key: Name
          Value: !Sub ${Env}--${System}--etd
  EcsTaskExecutionRole:
    UpdateReplacePolicy: "Retain"
    Type: "AWS::IAM::Role"
    DeletionPolicy: "Delete"
    Properties:
      Path: "/"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
      MaxSessionDuration: 3600
      RoleName: !Sub ${Env}--${System}--ecs-task--iar
      AssumeRolePolicyDocument:
        Version: "2008-10-17"
        Statement:
          - Action: "sts:AssumeRole"
            Effect: "Allow"
            Principal:
              Service: "ecs-tasks.amazonaws.com"
            Sid: ""
  EcsService:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref EcsCluster
      CapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Base: 0
          Weight: 1
      TaskDefinition: !Ref EcsTaskDefinition
      ServiceName: !Sub ${Env}--${System}--esv
      SchedulingStrategy: REPLICA
      DesiredCount: 1
      AvailabilityZoneRebalancing: ENABLED
      LoadBalancers:
        - ContainerName: !Sub ${Env}--${System}--container
          ContainerPort: 3000
          LoadBalancerName: !Ref AWS::NoValue
          TargetGroupArn: !Ref TargetGroupA
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
            Fn::Split:
              - ","
              - Fn::ImportValue: !Sub ${Env}--${System}--network--stack--system--sg
          Subnets:
            Fn::Split:
              - ","
              - Fn::ImportValue: !Sub ${Env}--${System}--network--stack--public--subnet
      PlatformVersion: LATEST
      DeploymentController:
        Type: CODE_DEPLOY
      ServiceConnectConfiguration:
        Enabled: false
      Tags: []
      EnableECSManagedTags: true
    DependsOn:
      - Listener
  TargetGroupA:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckPath: /
      Name: !Sub ${Env}--${System}--group-a--tg
      Port: 80
      Protocol: HTTP
      TargetType: ip
      HealthCheckProtocol: HTTP
      VpcId:
        Fn::ImportValue: !Sub ${Env}--${System}--network--stack--vpc
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: "300"
  Listener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroupA
      LoadBalancerArn: !Ref LoadBalancer
      Port: 80
      Protocol: HTTP
  TargetGroupB:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckPath: /
      Name: !Sub ${Env}--${System}--group-b--tg
      Port: 80
      Protocol: HTTP
      TargetType: ip
      HealthCheckProtocol: HTTP
      VpcId:
        Fn::ImportValue: !Sub ${Env}--${System}--network--stack--vpc
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: "300"
  CodeDeployDeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      ApplicationName: !Ref CodeDeployApplication
      DeploymentGroupName: !Sub ${Env}--${System}--cd--dg
      DeploymentConfigName: CodeDeployDefault.ECSAllAtOnce
      AutoRollbackConfiguration:
        Enabled: true
        Events:
          - DEPLOYMENT_FAILURE
          - DEPLOYMENT_STOP_ON_REQUEST
      BlueGreenDeploymentConfiguration:
        DeploymentReadyOption:
          ActionOnTimeout: CONTINUE_DEPLOYMENT
          WaitTimeInMinutes: 0
        TerminateBlueInstancesOnDeploymentSuccess:
          Action: TERMINATE
          TerminationWaitTimeInMinutes: 60
      DeploymentStyle:
        DeploymentOption: WITH_TRAFFIC_CONTROL
        DeploymentType: BLUE_GREEN
      LoadBalancerInfo:
        TargetGroupPairInfoList:
          - ProdTrafficRoute:
              ListenerArns:
                - !GetAtt Listener.ListenerArn
            TargetGroups:
              - Name: !GetAtt TargetGroupA.TargetGroupName
              - Name: !GetAtt TargetGroupB.TargetGroupName
      ServiceRoleArn: arn:aws:iam::032465545722:role/CodeDeployRoleforECS
      ECSServices:
        - ClusterName: !Sub ${Env}--${System}--ecs--cluster
          ServiceName: !Sub ${Env}--${System}--esv
      Tags: []
    DependsOn:
      - CodeDeployApplication
  CodeDeployApplication:
    Type: AWS::CodeDeploy::Application
    Properties:
      ApplicationName: !Sub ${Env}--${System}--cd--app
      ComputePlatform: ECS
      Tags: []
    DependsOn:
      - EcsService
  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Type: application
      Name: !Sub ${Env}--${System}--alb
      SecurityGroups:
        Fn::Split:
          - ","
          - Fn::ImportValue: !Sub ${Env}--${System}--network--stack--system--sg
      Subnets:
        Fn::Split:
          - ","
          - Fn::ImportValue: !Sub ${Env}--${System}--network--stack--public--subnet
Outputs:
  CodeDeployAppName:
    Description: CodeDeploy Application Name
    Value: !Ref CodeDeployApplication
    Export:
      Name: !Sub ${AWS::StackName}--cd--app
  CodeDeployDGName:
    Description: CodeDeploy Deployment Group Name
    Value: !Ref CodeDeployDeploymentGroup
    Export:
      Name: !Sub ${AWS::StackName}--cd--dg
